<script>
  $('#menusup').hide();
  EstatusBarColor('1565c0');
</script>
<div class="">
  <div class="w3-white w3-col l12">
    <div class="w3-white w3-container redondeo ">
      <div class="w3-margin-top w3-center">
        <div class="w3-center  w3-col s12 l12 m12 w3-small">~ USD <i id="carteraAlerta"
            class="fa-solid fa-clock-rotate-left  w3-right w3-large pointer" onclick="OpenAcount('Historial')"></i>
        </div>
        <h1 class="" style="min-height:72px" id="dinerocuent">&nbsp;</h1>
      </div>


    </div>



    <div class="w3-col l12 m12 s12  w3-center w3-padding-8 w3-container">
      <span
        class="w3-col s4 l4 m4 w3-border w3-text-grey w3-light-grey w3-border-light-grey w3-round w3-round-large pointer w3-left w3-margin-left"
        onclick="OpenAcount('Nueva cuenta')"><i class="fa-solid fa-plus w3-large"></i> Moneda</span>
      <span
        class="w3-col s4 l4 m4 w3-border w3-text-grey w3-light-grey w3-border-light-grey w3-round w3-round-large pointer w3-right w3-margin-right"
        onclick="OpenOption('retirar')">Retirar <i class="fa-solid fa-right-from-bracket"></i></span>
    </div>

  </div>

  <div class="noselect" style="margin-top: 0px">

    <div id='cuentanum0'></div>

    <div class="w3-container w3-display-middle w3-center" style="position:fixed;display:none" id="loaderspin">
      <i class="fas fa-spinner w3-spin fa-2x w3-text-grey"></i>
      <small class="w3-col s12 m12 l12 w3-padding-top">Cargando</small>
    </div>

  </div>
</div>

<!--Modal de deposito-->
<div id="CarteraDepositos" class="w3-modal noselect w3-col l12" style="display: none;">
  <div class="w3-display-middle  w3-white w3-round w3-round-xlarge w3-animate-fade  w3-col l5 m5 s12">
      <div class="reajuste" align="justify"> 
          <div class="w3-container" id="DatosCartera">
          </div> 
      
      </div>
      
      <div class="w3-col s12 m12 l12 w3-large w3-padding-16 w3-center  w3-border-top w3-border-lightgrey w3-text-blue" style="cursor:pointer" onclick="$('#CarteraDepositos').hide()">Cerrar</div>
  </div>
</div>
<!--Modal de deposito-->

<script>
  //MenuAccion('fa fa-plus',"OpenAcount('Nueva cuenta')");
  precioIntervalo = '';
  function formatNumber(num, decimal) {
    num = parseFloat(num).toFixed(decimal);
    if (decimal > 2) {
      return num;
    }
    else {
      return num.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1,");
    }
  }

  //Variables Glabales
  Bsimbolo = '';
  Bmoneda = '';
  Bdecimales = '';

  function seleccionarMoneda(nombre, moneda, decimales) {
    Bsimbolo = moneda;
    Bmoneda = nombre;
    Bdecimales = decimales;
    $('#DatosCartera').load('submenu/cuentas/billetera.html')
    $('#CarteraDepositos').show();
    //OpenAcount('billetera'); //redirigir al area de la moneda
  }

  $.ajax({
    url: 'https://' + UrlAPI + '/AppListadoMonedas',
    type: 'post',
    beforeSend: function () {
      //$('#loadergif').show(); 
      $('#loaderspin').show();
    },
    success: function (response) {
      $('#loadergif').hide();
      $('#loaderspin').hide();

      if (response == '') {

        $("#notifigener").removeClass('w3-green').addClass('w3-red');
        $("#notifigener").html("<p>No se ha obtenido resultados, compruebe su conexión</p>");
        $("#notifigener").show();
        setTimeout(function () { $("#notifigener").hide(); }, 6000);
      }
      else {

        var objt = JSON.parse(response);
        if (objt.session == 'true') {


          $('#dinerocuent').html(formatonumero(objt.balance, 2));
          //cuentas
          if (objt.content.length > 0) {


            for (i = 0; i < (objt.content.length); i++) {

              var datos = `'` + objt.monedas[objt.content[i].moneda].nombre + `','` + objt.content[i].moneda + `','` + objt.monedas[objt.content[i].moneda].decimalesUSD + `'`;
              decimalesCrypto = objt.monedas[objt.content[i].moneda].decimalesCrypto;
              decimalesUSD = objt.monedas[objt.content[i].moneda].decimalesUSD;

              var contenido = `
    <div class="w3-padding w3-row w3-border-bottom w3-border-light-grey w3-white w3-col s12 m12 l12"
         id="cuentanum${i + 1}">
        <div class="w3-col s2 m2 l2 w3-pading-top">
            <img onerror="this.onerror=null;this.src='https://paiexchange.com/appweb/icon/${objt.content[i].moneda}.png'"
                 src="icon/${objt.content[i].moneda}.png"
                 style="width:40px">
        </div>
        <div class="w3-col s10 m10 l10 w3-pading-top w3-text-grey">
            <div class="w3-col s6 m6 l6">
                ${objt.monedas[objt.content[i].moneda].nombre}
                <div class="w3-col s12 m12 l12 w3-padding-0 w3-small">
                    <i class="fa-solid fa-chart-simple" id="${objt.content[i].id}iconprice"></i>
                    <span id="${objt.content[i].id}price"></span> USD
                </div>
            </div>
            <div class="w3-col s3 m3 l3">
                <div class="">
                    ${objt.balances[objt.content[i].moneda] ? formatonumero(objt.balances[objt.content[i].moneda], decimalesCrypto) : formatonumero(0, decimalesCrypto)}
                </div> 
                <div class="w3-col s12 m12 l12">
                    <span class="w3-small">${objt.content[i].moneda}</span>
                </div>    
            </div>

            <div class="w3-col s3 m3 l3">
              <span class="pointer w3-right w3-text-blue" onclick="seleccionarMoneda(${datos})"><i class="fa-solid fa-download"></i> Depositar</span>
            </div>  
        </div>
    </div>`;



              $("#cuentanum" + i).after(contenido);
            }
            //$("#trst0").remove();
            //$("#trst1").before('<div class="w3-container"><h5>Transacciones</h5></div>');  


            //precios
            function MostrPrecios(arrayDecimales) {

              if (typeof JsonPrecios === 'undefined') {
                setTimeout(function () { MostrPrecios(arrayDecimales); }, 500);
              }
              else {
                console.log('entrando');
                for (i = 0; i < (objt.content.length); i++) {
                  (function (i) {
                    CODIGO = objt.content[i].moneda;
                    decimales = arrayDecimales[objt.content[i].moneda].decimalesUSD;


                    //agregando efectos de movimientos al icono del grafico
                    precioAntiguo = parseFloat($("#" + objt.content[i].id + "price").html().replace(/,/g, ''));
                    color = 'w3-text-grey';
                    Precio = parseFloat(JsonPrecios[CODIGO]).toFixed(decimales);
                    if (!isNaN(precioAntiguo)) {
                      if (precioAntiguo > Precio) {
                        color = 'w3-text-red w3-opacity';
                      }
                      else if (precioAntiguo < Precio) {
                        color = 'w3-text-green w3-opacity';
                      }
                      else {
                        color = 'w3-text-grey';
                      }
                    }
                    $("#" + objt.content[i].id + "price").html(formatonumero(Precio, decimales));
                    $("#" + objt.content[i].id + "iconprice").removeClass('w3-text-red w3-opacity').removeClass('w3-text-green w3-opacity').removeClass('w3-text-grey').addClass('fa-beat-fade').addClass(color);

                    setTimeout(function () {
                      $("#" + objt.content[i].id + "iconprice").removeClass('fa-beat-fade');
                    }, 5000);
                  })(i);
                }

              }

            }
            MostrPrecios(objt.monedas);
            var storedIntervalId = sessionStorage.getItem('intervalId');

            if (storedIntervalId) {
              clearInterval(parseInt(storedIntervalId));
            }

            var precioIntervalo = setInterval(function () {
              var namepath = window.location.pathname.split('/');
              if (namepath[(namepath.length) - 1] == 'Cartera') {
                MostrPrecios(objt.monedas);
              }
            }, 50000);

            sessionStorage.setItem('intervalId', precioIntervalo);




          }
          else {
            $("#cuentanum0").before('<div class="w3-container w3-white w3-center  w3-padding-64"><h4>No hay monedas agregadas</h4><p> Para agregar una cartera haga clic en la opción + agregar cartera. </p></div>');
          }

        }
        else {
          CerrarSesion();
        }



      }


    },

    error: function (response) {
      $("#notifigener").removeClass('w3-green').addClass('w3-red');
      $("#notifigener").html("<p>Verifique su conexión a internet</p>");
      $("#notifigener").show();
      setTimeout(function () { $("#notifigener").hide(); }, 6000);
      $('#loadergif').hide();
    }

  });

</script>
<script>
  function OpenAcount(id) {
    $.ajax({
      url: 'submenu/cuentas/' + id + '.html',
      type: 'post',
      beforeSend: function () {
        //$("#loadergif").show();
      },
      success: function (response) {
        $("#loadergif").hide();



        if (response == '') {

          $("#notifigener").removeClass('w3-green').addClass('w3-red');
          $("#notifigener").html("<p>No se ha obtenido resultados, compruebe su conexión</p>");
          $("#notifigener").show();
          setTimeout(function () { $("#notifigener").hide(); }, 6000);
        }
        else {
          $("#contenido").html(response);
          $("#titname").html(id);
          history.pushState(id, id, id);
        }


      },

      error: function (response) {
        $("#notifigener").removeClass('w3-green').addClass('w3-red');
        $("#notifigener").html("<p>Este contenido no está disponible, por favor actualice la aplicación</p>");
        $("#notifigener").show();
        setTimeout(function () { $("#notifigener").hide(); }, 6000);
        $("#loadergif").hide();
      }

    });
  }
</script>
<style>
  .dot {
    height: 50px;
    width: 50px;
    background-color: green;
    border-radius: 60%;
    display: inline-block;
  }
</style>